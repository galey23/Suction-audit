<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airway Suction Equipment Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f4f7f8; color: #222; }
    h1 { text-align: center; color: #1c3c4c; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    .form-group { margin-bottom: 15px; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }

    /* --- spacing between questions --- */
    .checklist-group{
      margin: 18px 0;
      padding: 10px 0 16px 0;
      padding-left: 10px;
      border-bottom: 1px solid #eee;
    }
    .checklist-group .question{
      font-weight: bold;
      display: block;
      margin-bottom: 12px;
      line-height: 1.35;
    }

    /* --- Bigger, side-by-side Yes/No --- */
    .yn-row {
      display: flex;
      gap: 28px;
      align-items: center;
      margin-bottom: 6px;
    }
    .yn-row label {
      font-weight: normal;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      margin-bottom: 0;
    }
    .yn-row input[type="radio"] {
      transform: scale(1.7);
      margin: 0;
    }

    .audit-block { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 6px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    button { background: #1c3c4c; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; }
    button:hover { background: #235067; }
    .submit-wrapper { text-align: center; margin-top: 30px; }
    .hint { font-size: 0.9em; color: #555; margin-top: 4px; }

    /* --- inline isolation selector next to Bed number --- */
    .iso-inline { font-weight: normal; margin-left: 10px; }
    .audit-block h3 select {
      font-family: inherit;
      font-size: inherit;
      padding: 2px 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: auto;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div style="text-align: center; margin-bottom: 20px;">
    <img src="MDH-Logo.jpg"
         alt="Mater Dei Hospital Logo"
         style="height: 90px; margin-right: 15px;">
    <img src="RRT Logo (no background).png"
         alt="Rapid Response Team Logo"
         style="height: 90px;">
  </div>

  <h1>Airway Suction Equipment Audit</h1>

  <form id="baseForm" onsubmit="return false;">
    <div class="form-group">
      <label for="auditor">Auditor Name:</label>
      <select id="auditor" required>
        <option value="">Select Auditor</option>
        <option>Bernard</option>
        <option>Clifford PDN</option>
        <option>Clint</option>
        <option>Daphne PDN</option>
        <option>Duncan PDN</option>
        <option>Jessica</option>
        <option>Josette</option>
        <option>Justin PDN</option>
        <option>Kristin PDN</option>
        <option>Lisa PDN</option>
        <option>Luke PDN</option>
        <option>Mario</option>
        <option>Mario PDN</option>
        <option>Miriam</option>
        <option>Nicole</option>
        <option>Stephanie</option>
        <option>Yorick</option>
      </select>
    </div>

    <div class="form-group">
      <label for="date">Date:</label>
      <input type="text" id="date" readonly />
    </div>

    <div class="form-group">
      <label for="ward">Ward / Area:</label>
      <select id="ward" required>
        <option value="">Select Ward / Area</option>

        <!-- Critical Care -->
        <optgroup label="Critical Care">
          <option>ED</option>
          <option>CCU</option>
          <option>SHDU</option>
          <option>NIV</option>
          <option>Cardiac Catheterisation Suite</option>
        </optgroup>

        <!-- Operating Theatres -->
        <optgroup label="Operating Theatres">
          <option>OT Pillar 1</option>
          <option>OT Pillar 2</option>
          <option>OT Pillar 3</option>
          <option>OT Pillar 4</option>
          <option>OT Recovery</option>
          <option>OT Endoscopy</option>
          <option>OT Endo Urology</option>
          <option>OT All Areas</option>
        </optgroup>

        <!-- Medical -->
        <optgroup label="Medical">
          <option>MAU1</option>
          <option>MAU2</option>
          <option>MAU3</option>
          <option>MW1</option>
          <option>MW2</option>
          <option>MW3</option>
          <option>MW4</option>
          <option>MW5</option>
          <option>MW7</option>
          <option>MW8</option>
          <option>MW9</option>
          <option>MW10</option>
          <option>HDU</option>
          <option>MW11</option>
          <option>MIU3</option>
          <option>MIU4</option>
          <option>OBS1A</option>
          <option>MOU</option>
          <option>EVA</option>
          <option>Auxiliary Ward 1</option>
          <option>Endoscopy Temp ward</option>
        </optgroup>

        <!-- Surgical -->
        <optgroup label="Surgical">
          <option>Plastics & Burns</option>
          <option>ORTHO 1</option>
          <option>ORTHO 2</option>
          <option>ORTHO 3</option>
          <option>SAU1</option>
          <option>SAU2</option>
          <option>SW1</option>
          <option>SW2</option>
          <option>SW3</option>
          <option>SW4</option>
          <option>SW5</option>
          <option>URO 1</option>
          <option>URO 2</option>
        </optgroup>

        <!-- Speciality Units -->
        <optgroup label="Speciality Units">
          <option>CMW</option>
          <option>CSW</option>
          <option>DFW</option>
          <option>ENT</option>
          <option>IDU</option>
          <option>STROKE WARD</option>
          <option>NEURO MED</option>
          <option>NEURO SURG</option>
          <option>SSU</option>
        </optgroup>

        <!-- OBGYN -->
        <optgroup label="OBGYN">
          <option>Gynae</option>
          <option>EPU</option>
          <option>OBS 1</option>
          <option>OBS 2</option>
          <option>OBS 3</option>
        </optgroup>

        <!-- SAMOC -->
        <optgroup label="SAMOC">
          <option>HEAMATOLOGY</option>
          <option>ONCO 1</option>
          <option>ONCO 2</option>
          <option>Onco Day Ward</option>
          <option>Palliative</option>
          <option>Renal Unit</option>
        </optgroup>
      </select>
      <div class="hint" id="wardHint">
        Capacity and sample size will be auto-filled based on the selected ward. The sample will be randomly generated but displayed in ascending order for easier ward routing.
      </div>
    </div>

    <div class="form-group" id="capacityGroup">
      <label for="bedCount" id="bedCountLabel">Total Beds in Ward:</label>
      <input type="number" id="bedCount" min="1" required />
    </div>

    <div class="form-group" id="sampleGroup">
      <label for="bedsToAudit" id="bedsToAuditLabel">Beds to Audit (sample size):</label>
      <input type="number" id="bedsToAudit" min="1" readonly />
    </div>

    <button type="button" id="generateBtn" onclick="generateAudits()">Generate Bed Audits</button>
  </form>

  <div id="auditContainer"></div>

  <div class="submit-wrapper">
    <button type="button" onclick="submitAudits()">Submit Ward Audit</button>
  </div>

<script>
/* ============================
   POWER AUTOMATE (ANYONE + SIG)
   ============================ */
const FLOW_URL = "https://default34cdd9f55db849bcacba01f65cca68.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ca817088bd6043a187a67a935e85c10e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Dc7DZx1A16KJ29fbIyygPEH1abfDOz41gnjCN7LEBCo";
const FLOW_TIMEOUT_MS = 25000;

// UTF-8 safe base64
function toBase64Utf8(str) {
  const bytes = new TextEncoder().encode(str);
  let binary = "";
  for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

async function postToFlow(payload) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), FLOW_TIMEOUT_MS);

  try {
    const res = await fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`Flow returned ${res.status}. ${txt}`);
    }
  } finally {
    clearTimeout(t);
  }
}

const QUESTIONS = [
  "High suction regulator is present and connected to the suction point",
  "Suction regulator functioning well: device turns on and audible suction present",
  "Suction regulator achieves a pressure of 100mmHg (13kPa)",
  "Suction canister present next to bed side",
  "Canister liner present",
  "Canister liner tubing present",
  "Liner tubing connected to suction regulator",
  "Patient side tubing present",
  "Compatible catheters present"
];

/* ============================
   ED LOCATIONS (FINAL)
============================ */
const ED_DECON = "Decontamination Room";

const ED_AREA1 = (() => {
  const out = [ED_DECON];
  for (let n = 8; n <= 15; n++) out.push(`Cubicle ${n}`);
  return out;
})();

const ED_AREA2 = (() => {
  const out = [];
  out.push("Cubicle 16A", "Cubicle 16B");
  for (let n = 17; n <= 21; n++) out.push(`Cubicle ${n}`);
  out.push("Cubicle 22A", "Cubicle 22B");
  out.push("Cubicle 23A", "Cubicle 23B");
  out.push("TH2");
  return out;
})();

const ED_AREA3 = (() => {
  const out = ["Cubicle 4", "Cubicle 5"];
  for (let n = 24; n <= 29; n++) out.push(`Cubicle ${n}`);
  out.push("TH1");
  return out;
})();

const ED_B_SIDES = ["Cubicle 16B", "Cubicle 22B", "Cubicle 23B"];
const ED_LOCATIONS = Array.from(new Set([...ED_AREA1, ...ED_AREA2, ...ED_AREA3]));

function randPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function randPickN(arr, n) {
  const copy = arr.slice();
  const picks = [];
  while (picks.length < n && copy.length) {
    const idx = Math.floor(Math.random() * copy.length);
    picks.push(copy[idx]);
    copy.splice(idx, 1);
  }
  return picks;
}

function edSort(a, b) {
  const areaOf = (s) => {
    if (ED_AREA1.includes(s)) return 1;
    if (ED_AREA2.includes(s)) return 2;
    if (ED_AREA3.includes(s)) return 3;
    return 9;
  };
  const Aarea = areaOf(a), Barea = areaOf(b);
  if (Aarea !== Barea) return Aarea - Barea;

  const parse = (s) => {
    const m = /^Cubicle\s+(\d+)([AB])?$/.exec(s);
    if (m) return { group: 0, num: parseInt(m[1], 10), suf: m[2] || "" };
    if (s === ED_DECON) return { group: 1, num: 0, suf: "" };
    if (s === "TH1") return { group: 2, num: 1, suf: "" };
    if (s === "TH2") return { group: 2, num: 2, suf: "" };
    return { group: 9, num: 0, suf: s };
  };

  const A = parse(a), B = parse(b);
  if (A.group !== B.group) return A.group - B.group;
  if (A.num !== B.num) return A.num - B.num;
  return (A.suf || "").localeCompare(B.suf || "");
}

function generateEDSelection(sampleSize) {
  if (sampleSize < 4) throw new Error("ED sample size must be at least 4.");
  if (sampleSize > ED_LOCATIONS.length) throw new Error(`ED sample size too large. Max = ${ED_LOCATIONS.length}.`);

  const chosen = new Set();

  chosen.add(ED_DECON);
  randPickN(ED_B_SIDES, 2).forEach(x => chosen.add(x));
  chosen.add(randPick(ED_AREA3));

  const pool = ED_LOCATIONS.filter(x => !chosen.has(x));
  while (chosen.size < sampleSize && pool.length) {
    const idx = Math.floor(Math.random() * pool.length);
    chosen.add(pool[idx]);
    pool.splice(idx, 1);
  }

  if (chosen.size > sampleSize) {
    const mustKeep = new Set([ED_DECON]);
    ED_B_SIDES.filter(x => chosen.has(x)).slice(0, 2).forEach(x => mustKeep.add(x));
    const a3 = ED_AREA3.find(x => chosen.has(x));
    if (a3) mustKeep.add(a3);

    for (const x of Array.from(chosen)) {
      if (chosen.size <= sampleSize) break;
      if (!mustKeep.has(x)) chosen.delete(x);
    }
  }

  return Array.from(chosen).sort(edSort);
}

/* ============================
   OPERATING THEATRES HELPERS
   ============================ */
function rangeLabels(prefix, start, end) {
  const out = [];
  for (let n = start; n <= end; n++) out.push(`${prefix} ${n}`);
  return out;
}

function recoveryPendentLabels() {
  const out = [];
  for (let p = 1; p <= 6; p++) out.push(`Pendent ${p}A`, `Pendent ${p}B`);
  return out;
}

const OT_ALL_LABELS = [
  ...rangeLabels("Theatre", 1, 5),
  ...rangeLabels("Theatre", 8, 14),
  ...rangeLabels("Theatre", 15, 20),
  "Theatre CPOD", "Theatre Trauma 1",
  ...recoveryPendentLabels(),
  ...rangeLabels("Endoscopy Theatre", 1, 5),
  "Endo Urology"
];

/* ============================
   ONCO DAY WARD (STRATIFIED) HELPERS
   ============================ */
function makeAreaBeds(areaName, count) {
  const out = [];
  for (let i = 1; i <= count; i++) out.push(`${areaName} - Bed ${i}`);
  return out;
}

function parseAreaBedLabel(s) {
  const m = /^(.*?)\s-\sBed\s(\d+)$/.exec(String(s).trim());
  if (!m) return { area: String(s), num: Number.POSITIVE_INFINITY };
  return { area: m[1], num: parseInt(m[2], 10) };
}

function stratifiedSortFactory(areaOrder) {
  const idx = new Map(areaOrder.map((a, i) => [a, i]));
  return (a, b) => {
    const A = parseAreaBedLabel(a);
    const B = parseAreaBedLabel(b);
    const ai = idx.has(A.area) ? idx.get(A.area) : 999;
    const bi = idx.has(B.area) ? idx.get(B.area) : 999;
    if (ai !== bi) return ai - bi;
    if (A.num !== B.num) return A.num - B.num;
    return String(a).localeCompare(String(b));
  };
}

function generateStratifiedSelection(strata) {
  const picks = [];
  for (const s of strata) {
    if (!Array.isArray(s.labels)) throw new Error("Invalid strata labels.");
    if (s.sample > s.labels.length) throw new Error(`Sample too large in ${s.name}.`);
    picks.push(...randPickN(s.labels, s.sample));
  }
  const areaOrder = strata.map(s => s.name);
  return picks.sort(stratifiedSortFactory(areaOrder));
}

/* ============================
   WARD CONFIGURATION
   ============================ */
const WARD_CONFIG = {
  "ED":            { capacity: 35, sample: 14 },
  "CCU":           { capacity: 15, sample: 6 },
  "SHDU":          { capacity: 8,  sample: 4 },
  "NIV":           { capacity: 6,  sample: 3 },
  "Cardiac Catheterisation Suite": { capacity: 16, sample: 7 },

  // ===== Operating Theatres (FULL AUDIT) =====
  "OT Pillar 1": {
    capacity: 5, sample: 5,
    auditMode: "full",
    labels: rangeLabels("Theatre", 1, 5),
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT Pillar 2": {
    capacity: 7, sample: 7,
    auditMode: "full",
    labels: rangeLabels("Theatre", 8, 14),
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT Pillar 3": {
    capacity: 6, sample: 6,
    auditMode: "full",
    labels: rangeLabels("Theatre", 15, 20),
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT Pillar 4": {
    capacity: 2, sample: 2,
    auditMode: "full",
    labels: ["Theatre CPOD", "Theatre Trauma 1"],
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT Recovery": {
    capacity: 12, sample: 12,
    auditMode: "full",
    labels: recoveryPendentLabels(),
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT Endoscopy": {
    capacity: 5, sample: 5,
    auditMode: "full",
    labels: rangeLabels("Endoscopy Theatre", 1, 5),
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT Endo Urology": {
    capacity: 1, sample: 1,
    auditMode: "full",
    labels: ["Endo Urology"],
    lockCapacity: true,
    unitType: "audit-point"
  },
  "OT All Areas": {
    capacity: OT_ALL_LABELS.length,
    sample: OT_ALL_LABELS.length,
    auditMode: "full",
    labels: OT_ALL_LABELS,
    lockCapacity: true,
    unitType: "audit-point"
  },

  // Medical
  "MAU1":          { capacity: 35, sample: 14 },
  "MAU2":          { capacity: 33, sample: 14 },
  "MAU3":          { capacity: 23, sample: 10 },
  "MW1":           { capacity: 25, sample: 10 },
  "MW2":           { capacity: 25, sample: 10 },
  "MW3":           { capacity: 24, sample: 10 },
  "MW4":           { capacity: 25, sample: 10 },
  "MW5":           { capacity: 39, sample: 16 },
  "MW7":           { capacity: 19, sample: 8 },
  "MW8":           { capacity: 15, sample: 6 },
  "MW9":           { capacity: 23, sample: 10 },
  "MW10":          { capacity: 30, sample: 12 },
  "HDU":           { capacity: 10, sample: 4 },
  "MW11":          { capacity: 30, sample: 12 },
  "MIU3":          { capacity: 14, sample: 6 },
  "MIU4":          { capacity: 24, sample: 10 },
  "OBS1A":         { capacity: 10, sample: 4 },
  "MOU":           { capacity: 13, sample: 6 },
  "EVA":           { capacity: 20, sample: 8 },
  "Auxiliary Ward 1":{ capacity: 11, sample: 5 },
  "Endoscopy Temp ward":{ capacity: 11, sample: 5 },

  // Surgical
  "Plastics & Burns": { capacity: 11,  sample: 5 },
  "ORTHO 1":       { capacity: 24, sample: 10 },
  "ORTHO 2":       { capacity: 24, sample: 10 },
  "ORTHO 3":       { capacity: 21, sample: 9 },
  "SAU1":          { capacity: 20, sample: 8 },
  "SAU2":          { capacity: 32, sample: 13 },
  "SW1":           { capacity: 25, sample: 10 },
  "SW2":           { capacity: 16, sample: 7 },
  "SW3":           { capacity: 24, sample: 10 },
  "SW4":           { capacity: 24, sample: 10 },
  "SW5":           { capacity: 25, sample: 10 },
  "URO 1":         { capacity: 25, sample: 10 },
  "URO 2":         { capacity: 11, sample: 5 },

  // Speciality Units
  "CMW":           { capacity: 32, sample: 13 },
  "CSW":           { capacity: 17, sample: 7 },
  "DFW":           { capacity: 15, sample: 6 },
  "ENT":           { capacity: 18, sample: 8 },
  "IDU":           { capacity: 20, sample: 8 },
  "STROKE WARD":   { capacity: 25, sample: 10 },
  "NEURO MED":     { capacity: 23, sample: 10 },
  "NEURO SURG":    { capacity: 19, sample: 8 },
  "SSU":           { capacity: 29, sample: 12 },

  // OBGYN
  "Gynae":         { capacity: 11, sample: 5 },
  "EPU":           { capacity: 6,  sample: 3 },
  "OBS 1":         { capacity: 24, sample: 10 },
  "OBS 2":         { capacity: 19, sample: 8 },
  "OBS 3":         { capacity: 20, sample: 8 },

  // SAMOC
  "HEAMATOLOGY":   { capacity: 21, sample: 9 },
  "ONCO 1":        { capacity: 16, sample: 7 },
  "ONCO 2":        { capacity: 17, sample: 7 },

  // UPDATED: Onco Day Ward = 27 beds, stratified random sample per area
  "Onco Day Ward": {
    capacity: 27,
    sample: 14,            // 4 + 3 + 4 + 3
    auditMode: "stratified",
    lockCapacity: true,
    strata: [
      { name: "Area 1",     labels: makeAreaBeds("Area 1", 8),     sample: 4 },
      { name: "Area 2",     labels: makeAreaBeds("Area 2", 5),     sample: 3 },
      { name: "Area 3",     labels: makeAreaBeds("Area 3", 8),     sample: 4 },
      { name: "Beds Area",  labels: makeAreaBeds("Beds Area", 6),  sample: 3 }
    ]
  },

  "Palliative":    { capacity: 16, sample: 7 },
  "Renal Unit":    { capacity: 35, sample: 14 }
};

function getUnitTerms(ward) {
  const cfg = WARD_CONFIG[ward];
  if (ward === "ED") return { singular: "location", plural: "locations" };
  if (cfg && cfg.unitType === "audit-point") return { singular: "audit point", plural: "audit points" };
  return { singular: "bed", plural: "beds" };
}

/* Auto-fill date + bind */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("date").value = new Date().toLocaleDateString("en-GB");
  document.getElementById("ward").addEventListener("change", onWardChange);
});

function onWardChange() {
  const ward = document.getElementById("ward").value;
  const config = WARD_CONFIG[ward];

  const bedCountInput = document.getElementById("bedCount");
  const bedsToAuditInput = document.getElementById("bedsToAudit");

  const bedCountLabel = document.getElementById("bedCountLabel");
  const bedsToAuditLabel = document.getElementById("bedsToAuditLabel");
  const wardHint = document.getElementById("wardHint");
  const generateBtn = document.getElementById("generateBtn");

  const terms = getUnitTerms(ward);

  if (config) {
    bedCountInput.value = config.capacity;
    bedsToAuditInput.value = config.sample;

    bedCountInput.readOnly = !!config.lockCapacity;

    if (terms.plural === "audit points") {
      bedCountLabel.textContent = "Total Audit Points in Area:";
      bedsToAuditLabel.textContent = "Audit Points to Audit (full):";
      wardHint.textContent = "This area is audited in full. All audit points will be generated (no random sampling).";
      generateBtn.textContent = "Generate Audit Points";
    } else if (terms.plural === "locations") {
      bedCountLabel.textContent = "Total Locations in Area:";
      bedsToAuditLabel.textContent = "Locations to Audit (sample size):";
      wardHint.textContent =
        "Capacity and sample size will be auto-filled based on the selected area. " +
        "The sample will be randomly generated but displayed in an ordered way for easier routing.";
      generateBtn.textContent = "Generate Location Audits";
    } else {
      bedCountLabel.textContent = "Total Beds in Ward:";
      bedsToAuditLabel.textContent = "Beds to Audit (sample size):";
      wardHint.textContent =
        "Capacity and sample size will be auto-filled based on the selected ward. " +
        "The sample will be randomly generated but displayed in ascending order for easier ward routing.";
      generateBtn.textContent = "Generate Bed Audits";
    }
  } else {
    bedCountInput.value = "";
    bedsToAuditInput.value = "";
    bedCountInput.readOnly = false;

    bedCountLabel.textContent = "Total Beds in Ward:";
    bedsToAuditLabel.textContent = "Beds to Audit (sample size):";
    wardHint.textContent =
      "Capacity and sample size will be auto-filled based on the selected ward. " +
      "The sample will be randomly generated but displayed in ascending order for easier ward routing.";
    generateBtn.textContent = "Generate Bed Audits";
  }

  document.getElementById("auditContainer").innerHTML = "";
}

function generateAudits() {
  const ward = document.getElementById("ward").value;
  const bedCount = parseInt(document.getElementById("bedCount").value, 10);
  const bedsToAudit = parseInt(document.getElementById("bedsToAudit").value, 10);
  const container = document.getElementById("auditContainer");

  const config = WARD_CONFIG[ward];
  const terms = getUnitTerms(ward);

  if (!ward) return alert("Please select a ward/area.");
  if (!bedCount || bedCount < 1) return alert("Please ensure the capacity value is valid.");
  if (!bedsToAudit || bedsToAudit < 1) return alert("Please ensure the sample size value is valid.");
  if (ward !== "ED" && bedsToAudit > bedCount) return alert(`Items to audit cannot exceed the total ${terms.plural} in the area.`);

  container.innerHTML = "";

  let selections = [];

  if (ward === "ED") {
    selections = generateEDSelection(bedsToAudit);
  } else if (config && config.auditMode === "full") {
    if (Array.isArray(config.labels) && config.labels.length) {
      selections = config.labels.slice();
    } else {
      selections = Array.from({ length: bedCount }, (_, i) => `Bed ${i + 1}`);
    }
  } else if (config && config.auditMode === "stratified") {
    // Onco Day Ward: random within each area, then ordered for routing (Area order, then bed number)
    selections = generateStratifiedSelection(config.strata || []);
  } else {
    // Normal wards: random sample, displayed in ascending order
    const nums = [];
    while (nums.length < bedsToAudit) {
      const n = Math.floor(Math.random() * bedCount) + 1;
      if (!nums.includes(n)) nums.push(n);
    }
    nums.sort((a, b) => a - b);
    selections = nums.map(n => `Bed ${n}`);
  }

  selections.forEach((label, index) => {
    const div = document.createElement("div");
    div.className = "audit-block";
    div.dataset.bed = label;

    div.innerHTML = `
      <h3>
        Audit ${index + 1}: ${label}
        <span class="iso-inline">| Single/Isolation room?
          <select name="iso${index}" required>
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </span>
      </h3>
      ${generateChecklistInputs(index)}
    `;
    container.appendChild(div);
  });

  window.scrollTo({ top: container.offsetTop - 10, behavior: "smooth" });
}

function generateChecklistInputs(index) {
  return QUESTIONS.map((q, i) => `
    <div class="checklist-group">
      <label class="question">${q}</label>
      <div class="yn-row">
        <label><input type="radio" name="q${index}_${i}" value="Yes" required> Yes</label>
        <label><input type="radio" name="q${index}_${i}" value="No"> No</label>
      </div>
    </div>
  `).join("");
}

/* CSV helpers */
function csvEscape(val) {
  if (val == null) return "";
  const s = String(val);
  return /[",\r\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
}

function formatPct(num) {
  if (!isFinite(num)) return "";
  const fixed = num.toFixed(1);
  const tidy = fixed.endsWith(".0") ? fixed.slice(0, -2) : fixed;
  return `${tidy}%`;
}

/* CSV layout like your screenshot (right-side ward panel column) */
function auditsToCSV(audits) {
  const header = ["Date","Auditor","Ward","Bed","Single/Isolation Room","Compliance (%)","Non-compliant Items"]
    .concat(QUESTIONS.map((_, i) => `Q${i + 1}`))
    .concat(["WARD"]);

  const totalYes = audits.reduce((acc, a) => acc + (a.answers || []).filter(x => x === "Yes").length, 0);
  const wardComplianceNum = audits.length ? (totalYes / (audits.length * QUESTIONS.length)) * 100 : NaN;
  const wardComplianceStr = formatPct(wardComplianceNum);

  const lines = [header.map(csvEscape).join(",")];

  audits.forEach((a, idx) => {
    let wardPanel = "";
    if (audits.length >= 3) {
      if (idx === 0) wardPanel = a.ward || "";
      else if (idx === 1) wardPanel = "Overall\nward\ncompliance";
      else if (idx === 2) wardPanel = wardComplianceStr;
    } else if (audits.length === 2) {
      if (idx === 0) wardPanel = a.ward || "";
      else if (idx === 1) wardPanel = `Overall\nward\ncompliance\n${wardComplianceStr}`;
    } else if (audits.length === 1) {
      wardPanel = `${a.ward || ""}\nOverall\nward\ncompliance\n${wardComplianceStr}`;
    }

    const row = [
      a.date,
      a.auditor,
      a.ward,
      a.bed,
      a.isolationRoom,
      a.compliance,
      a.nonCompliantItems
    ]
    .map(csvEscape)
    .concat((a.answers || []).map(csvEscape))
    .concat([csvEscape(wardPanel)]);

    lines.push(row.join(","));
  });

  return lines.join("\r\n");
}

// Cross-platform CSV download / share
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

  const a = document.createElement("a");
  const supportsDownloadAttr = "download" in a;
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua);

  if (!isIOS && supportsDownloadAttr) {
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
    return { mode: "download" };
  }

  if (navigator.share) {
    try {
      const file = new File([csv], filename, { type: "text/csv" });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          files: [file],
          title: "Suction Audit Export",
          text: "CSV export from Suction Equipment Audit"
        });
        return { mode: "share-file" };
      }
    } catch (e) {}

    navigator.share({ title: "Suction Audit Export", text: csv }).catch(() => {});
    return { mode: "share-text" };
  }

  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 60000);
  return { mode: "open-tab" };
}

/* SUBMIT */
async function submitAudits() {
  const auditor = document.getElementById("auditor").value;
  const date = document.getElementById("date").value;
  const ward = document.getElementById("ward").value;
  const blocks = document.querySelectorAll(".audit-block");

  if (!auditor || !ward || blocks.length === 0) {
    alert("Please fill auditor, select ward/area and generate the audits first.");
    return;
  }

  const audits = [];

  for (let index = 0; index < blocks.length; index++) {
    const block = blocks[index];
    const bed = block.dataset.bed || (block.querySelector("h3")?.innerText || `Audit ${index+1}`);

    const isoSelect = block.querySelector(`select[name="iso${index}"]`);
    const isolationRoom = isoSelect ? isoSelect.value : "";

    if (!isolationRoom) {
      alert(`Please select Single/Isolation room = Yes/No for ${bed}.`);
      block.scrollIntoView({ behavior: "smooth", block: "center" });
      return;
    }

    const answers = [];
    let yesCount = 0;
    const nonCompliant = [];

    block.querySelectorAll(".checklist-group").forEach((group, i) => {
      const radios = group.querySelectorAll(`input[name="q${index}_${i}"]`);
      let picked = "";
      radios.forEach(r => { if (r.checked) picked = r.value; });
      answers.push(picked);
      if (picked === "Yes") yesCount++;
      else if (picked === "No") nonCompliant.push(group.querySelector(".question").innerText);
    });

    const complianceNum = (yesCount / QUESTIONS.length) * 100;
    const compliance = complianceNum.toFixed(1);

    audits.push({
      date, auditor, ward, bed,
      isolationRoom,
      compliance,
      nonCompliantItems: nonCompliant.join("; ") || "None",
      answers
    });
  }

  const safeWard = ward.replace(/[^\w\- ]+/g,"").replace(/\s+/g,"_");
  const safeDate = date.replace(/\//g,"-");
  const filename = `SuctionAudit_${safeWard}_${safeDate}.csv`;
  const csv = auditsToCSV(audits);

  try {
    await postToFlow({ date, auditor, ward, filename, csvBase64: toBase64Utf8(csv) });
    alert("Audit complete. Sent to rrt.mdh@gov.mt.");
  } catch (e) {
    console.error(e);
    const result = downloadCSV(csv, filename);
    const ua = navigator.userAgent || "";
    const isIOS = /iPad|iPhone|iPod/.test(ua);

    if (result.mode === "download") {
      alert("Could not send email (network/flow/CORS issue). CSV file downloaded instead.");
    } else if (result.mode === "share-file" || result.mode === "share-text") {
      alert("Could not send email. Share sheet opened – choose where to save or send the CSV.");
    } else if (isIOS && result.mode === "open-tab") {
      alert("Could not send email. A new tab opened with the CSV – tap Share → “Save to Files”.");
    } else {
      alert("Could not send email. CSV opened in a new tab – use your browser’s Save function.");
    }
  }
}
</script>
</body>
</html>
