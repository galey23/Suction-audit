<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Suction Equipment Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f4f7f8; color: #222; }
    h1 { text-align: center; color: #1c3c4c; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    .form-group { margin-bottom: 15px; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
    .checklist-group { margin: 10px 0; padding-left: 10px; }
    .checklist-group input[type="radio"] { margin-right: 10px; transform: scale(1.2); }
    .audit-block { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 6px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    button { background: #1c3c4c; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; }
    button:hover { background: #235067; }
    .submit-wrapper { text-align: center; margin-top: 30px; }
    .hint { font-size: 0.9em; color: #555; margin-top: 4px; }

    /* --- ADDED: inline isolation selector next to Bed number, matching font --- */
    .iso-inline { font-weight: normal; margin-left: 10px; }
    .audit-block h3 select {
      font-family: inherit;
      font-size: inherit;
      padding: 2px 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: auto;            /* keep it inline instead of full width */
      vertical-align: middle; /* align with text */
    }
  </style>
</head>
<body>
  <div style="text-align: center; margin-bottom: 20px;">
    <img src="MDH-Logo.jpg"
         alt="Mater Dei Hospital Logo"
         style="height: 90px; margin-right: 15px;">
    <img src="RRT Logo (no background).png"
         alt="Rapid Response Team Logo"
         style="height: 90px;">
  </div>

  <h1>Suction Equipment Audit</h1>

  <form id="baseForm" onsubmit="return false;">
    <div class="form-group">
      <label for="auditor">Auditor Name:</label>
      <select id="auditor" required>
        <option value="">Select Auditor</option>
        <option>Yorick</option>
        <option>Duncan PDN</option>
        <option>Jessica</option>
        <option>Bernard</option>
        <option>Nicole</option>
        <option>Stephanie</option>
        <option>Mario</option>
        <option>Miriam</option>
        <option>Josette</option>
        <option>Clint</option>
        <option>Clifford PDN</option>
        <option>Mario PDN</option>
        <option>Justin PDN</option>
        <option>Luke PDN</option>
        <option>Kirstin PDN</option>
      </select>
    </div>

    <div class="form-group">
      <label for="date">Date:</label>
      <input type="text" id="date" readonly />
    </div>

    <div class="form-group">
      <label for="ward">Ward:</label>
      <select id="ward" required>
        <option value="">Select Ward</option>
        <!-- Critical Care -->
        <option>CCU</option>
        <option>SHDU</option>
        <option>NIV</option>
        <!-- Medical -->
        <option>MAU1</option>
        <option>MAU2</option>
        <option>MAU3</option>
        <option>MW1</option>
        <option>MW2</option>
        <option>MW3</option>
        <option>MW4</option>
        <option>MW5</option>
        <option>MW7</option>
        <option>MW8</option>
        <option>MW9</option>
        <option>MW10</option>
        <option>HDU</option>
        <option>MW11</option>
        <option>MIU3</option>
        <option>MIU4</option>
        <option>OBS1A</option>
        <option>MOU</option>
        <option>EVA</option>
        <option>Auxiliary Ward</option>
        <option>Endoscopy medical</option>
        <!-- Surgical -->
        <option>PLASITICS</option>
        <option>BRUNS</option>
        <option>ORTHO 1</option>
        <option>ORTHO 2</option>
        <option>ORTHO 3</option>
        <option>SAU1</option>
        <option>SAU2</option>
        <option>SW1</option>
        <option>SW2</option>
        <option>SW3</option>
        <option>SW4</option>
        <option>SW5</option>
        <option>URO 1</option>
        <option>URO 2</option>
        <!-- Speciality Units -->
        <option>CMW</option>
        <option>CSW</option>
        <option>DFW</option>
        <option>ENT</option>
        <option>IDU</option>
        <option>STROKE WARD</option>
        <option>NEURO MED</option>
        <option>NEURO SURG</option>
        <option>SSU</option>
        <!-- OBGYN -->
        <option>Gynae</option>
        <option>EPU</option>
        <option>OBS 1</option>
        <option>OBS 2</option>
        <option>OBS 3</option>
        <!-- SAMOC -->
        <option>HEAMATOLOGY</option>
        <option>ONCO 1</option>
        <option>ONCO 2</option>
        <option>Day Ward</option>
        <option>Palliative</option>
        <option>Renal Unit</option>
      </select>
      <div class="hint">Capacity and number of beds to audit will be auto-filled based on the selected ward.</div>
    </div>

    <div class="form-group">
      <label for="bedCount">Total Beds in Ward:</label>
      <input type="number" id="bedCount" min="1" required />
    </div>

    <div class="form-group">
      <label for="bedsToAudit">Beds to Audit (sample size):</label>
      <input type="number" id="bedsToAudit" min="1" readonly />
    </div>

    <button type="button" onclick="generateAudits()">Generate Bed Audits</button>
  </form>

  <div id="auditContainer"></div>

  <div class="submit-wrapper">
    <button type="button" onclick="submitAudits()">Submit Ward Audit</button>
  </div>

<script>
const QUESTIONS = [
  "Suction regulator plugged in to point",
  "Suction regulator functioning",
  "Suction canister present next to bed side",
  "Canister liner present",
  "Canister liner tubing present",
  "Liner tubing connected to suction regulator",
  "Suction set achieves a minimum pressure of 80mmHG (10kPa)",
  "Patient side tubing present - soft tip catheters (and/or) Yankeur",
  "Compatible catheters present"
];

// Ward configuration: capacity & number of beds to audit
const WARD_CONFIG = {
  // Critical Care
  "CCU":           { capacity: 15, sample: 6 },
  "SHDU":          { capacity: 8,  sample: 4 },
  "NIV":           { capacity: 6,  sample: 3 },

  // Medical
  "MAU1":          { capacity: 35, sample: 14 },
  "MAU2":          { capacity: 33, sample: 14 },
  "MAU3":          { capacity: 23, sample: 10 },
  "MW1":           { capacity: 25, sample: 10 },
  "MW2":           { capacity: 25, sample: 10 },
  "MW3":           { capacity: 24, sample: 10 },
  "MW4":           { capacity: 25, sample: 10 },
  "MW5":           { capacity: 39, sample: 16 },
  "MW7":           { capacity: 19, sample: 8 },
  "MW8":           { capacity: 15, sample: 6 },
  "MW9":           { capacity: 23, sample: 10 },
  "MW10":          { capacity: 30, sample: 12 },
  "HDU":           { capacity: 10, sample: 4 },
  "MW11":          { capacity: 30, sample: 12 },
  "MIU3":          { capacity: 14, sample: 6 },
  "MIU4":          { capacity: 24, sample: 10 },
  "OBS1A":         { capacity: 10, sample: 4 },
  "MOU":           { capacity: 13, sample: 6 },
  "EVA":           { capacity: 20, sample: 8 },
  "Auxiliary Ward":{ capacity: 10, sample: 4 },
  "Endoscopy Medical":{ capacity: 10, sample: 4 },

  // Surgical
  "PLASITICS":     { capacity: 7,  sample: 3 },
  "BRUNS":         { capacity: 4,  sample: 2 },
  "ORTHO 1":       { capacity: 24, sample: 10 },
  "ORTHO 2":       { capacity: 24, sample: 10 },
  "ORTHO 3":       { capacity: 21, sample: 9 },
  "SAU1":          { capacity: 20, sample: 8 },
  "SAU2":          { capacity: 32, sample: 13 },
  "SW1":           { capacity: 25, sample: 10 },
  "SW2":           { capacity: 16, sample: 7 },
  "SW3":           { capacity: 24, sample: 10 },
  "SW4":           { capacity: 24, sample: 10 },
  "SW5":           { capacity: 25, sample: 10 },
  "URO 1":         { capacity: 25, sample: 10 },
  "URO 2":         { capacity: 11, sample: 5 },

  // Speciality Units
  "CMW":           { capacity: 32, sample: 13 },
  "CSW":           { capacity: 17, sample: 7 },
  "DFW":           { capacity: 15, sample: 6 },
  "ENT":           { capacity: 18, sample: 8 },
  "IDU":           { capacity: 20, sample: 8 },
  "STROKE WARD":   { capacity: 25, sample: 10 },
  "NEURO MED":     { capacity: 23, sample: 10 },
  "NEURO SURG":    { capacity: 19, sample: 8 },
  "SSU":           { capacity: 29, sample: 12 },

  // OBGYN
  "Gynae":          { capacity: 11, sample: 5 },
  "EPU":           { capacity: 6,  sample: 3 },
  "OBS 1":         { capacity: 24, sample: 10 },
  "OBS 2":         { capacity: 19, sample: 8 },
  "OBS 3":         { capacity: 20, sample: 8 },

  // SAMOC
  "HEAMATOLOGY":   { capacity: 19, sample: 8 },
  "ONCO 1":        { capacity: 19, sample: 8 },
  "ONCO 2":        { capacity: 19, sample: 8 },
  "Day ward":      { capacity: 45, sample: 18 },
  "Palliative":    { capacity: 19, sample: 8 },
  "Renal Unit":    { capacity: 35, sample: 14 }
};

// Auto-fill date (dd/mm/yyyy EN-GB)
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  const formattedDate = today.toLocaleDateString("en-GB");
  document.getElementById("date").value = formattedDate;

  // When ward changes, auto-fill capacity & sample size
  document.getElementById("ward").addEventListener("change", onWardChange);
});

function onWardChange() {
  const ward = document.getElementById("ward").value;
  const config = WARD_CONFIG[ward];
  const bedCountInput = document.getElementById("bedCount");
  const bedsToAuditInput = document.getElementById("bedsToAudit");

  if (config) {
    bedCountInput.value = config.capacity;
    bedsToAuditInput.value = config.sample;
  } else {
    // If a ward is not in the config (fallback)
    bedCountInput.value = "";
    bedsToAuditInput.value = "";
  }

  // Clear any previously generated audits when ward changes
  document.getElementById("auditContainer").innerHTML = "";
}

// Generate audits according to ward config
function generateAudits() {
  const ward = document.getElementById("ward").value;
  const bedCount = parseInt(document.getElementById("bedCount").value, 10);
  const bedsToAudit = parseInt(document.getElementById("bedsToAudit").value, 10);
  const container = document.getElementById("auditContainer");

  if (!ward) {
    alert("Please select a ward.");
    return;
  }

  if (!bedCount || bedCount < 1) {
    alert("Please ensure the total number of beds is valid.");
    return;
  }

  if (!bedsToAudit || bedsToAudit < 1) {
    alert("Please ensure the number of beds to audit is valid.");
    return;
  }

  if (bedsToAudit > bedCount) {
    alert("The number of beds to audit cannot exceed the ward capacity.");
    return;
  }

  container.innerHTML = "";
  const bedNumbers = [];
  while (bedNumbers.length < bedsToAudit) {
    const n = Math.floor(Math.random() * bedCount) + 1;
    if (!bedNumbers.includes(n)) bedNumbers.push(n);
  }

  // sort bed numbers from smallest to largest for sensible walking order
  bedNumbers.sort((a, b) => a - b);

  bedNumbers.forEach((bedNum, index) => {
    const div = document.createElement("div");
    div.className = "audit-block";

    /* --- ADDED: isolation/single room selector next to Bed number --- */
    div.innerHTML = `
      <h3>
        Audit ${index + 1}: Bed ${bedNum}
        <span class="iso-inline">| Single/Isolation room?
          <select name="iso${index}" required>
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </span>
      </h3>
      ${generateChecklistInputs(index)}
    `;
    container.appendChild(div);
  });

  window.scrollTo({ top: container.offsetTop - 10, behavior: "smooth" });
}

function generateChecklistInputs(index) {
  return QUESTIONS.map((q, i) => `
    <div class="checklist-group">
      <label>${q}</label><br>
      <label><input type="radio" name="q${index}_${i}" value="Yes" required> Yes</label>
      <label><input type="radio" name="q${index}_${i}" value="No"> No</label>
    </div>
  `).join("");
}

// ---- CSV helpers ----
function csvEscape(val) {
  if (val == null) return "";
  const s = String(val);
  return /[",\r\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
}

function auditsToCSV(audits) {
  /* --- ADDED: "Single/Isolation Room" column --- */
  const header = ["Date","Auditor","Ward","Bed","Single/Isolation Room","Compliance (%)","Non-compliant Items"]
                 .concat(QUESTIONS.map((_,i)=>`Q${i+1}`));
  const lines = [header.map(csvEscape).join(",")];
  audits.forEach(a => {
    const row = [a.date, a.auditor, a.ward, a.bed, a.isolationRoom, a.compliance, a.nonCompliantItems]
      .map(csvEscape).concat((a.answers||[]).map(csvEscape));
    lines.push(row.join(","));
  });
  return lines.join("\r\n");
}

// Cross-platform CSV download / share
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

  const a = document.createElement("a");
  const supportsDownloadAttr = "download" in a;
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua);
  const isAndroid = /Android/.test(ua);

  // 1. DESKTOP + ANDROID: normal download
  if (!isIOS && supportsDownloadAttr) {
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
    return { mode: "download" };
  }

  // 2. iOS / ANDROID with Web Share API
  if (navigator.share) {
    try {
      const file = new File([csv], filename, { type: "text/csv" });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          files: [file],
          title: "Suction Audit Export",
          text: "CSV export from Suction Equipment Audit"
        });
        return { mode: "share-file" };
      }
    } catch (e) {
      // fall through
    }

    navigator.share({
      title: "Suction Audit Export",
      text: csv
    }).catch(() => {});
    return { mode: "share-text" };
  }

  // 3. LAST RESORT (mainly older iOS): open CSV in a new tab
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 60000);
  return { mode: "open-tab" };
}

function submitAudits() {
  const auditor = document.getElementById("auditor").value;
  const date = document.getElementById("date").value;
  const ward = document.getElementById("ward").value;
  const blocks = document.querySelectorAll(".audit-block");

  if (!auditor || !ward || blocks.length === 0) {
    alert("Please fill auditor, select ward and generate the audits first.");
    return;
  }

  const audits = [];

  // NOTE: using a normal for-loop so we can safely "return" on validation errors.
  for (let index = 0; index < blocks.length; index++) {
    const block = blocks[index];

    const bedTitle = block.querySelector("h3").innerText;
    const bedMatch = bedTitle.match(/Bed\s+(\d+)/i);
    const bed = bedMatch ? bedMatch[1] : bedTitle;

    /* --- ADDED: read isolation/single room selection --- */
    const isoSelect = block.querySelector(`select[name="iso${index}"]`);
    const isolationRoom = isoSelect ? isoSelect.value : "";

    if (!isolationRoom) {
      alert(`Please select Single/Isolation room = Yes/No for Bed ${bed}.`);
      block.scrollIntoView({ behavior: "smooth", block: "center" });
      return;
    }

    const answers = [];
    let yesCount = 0;
    const nonCompliant = [];

    block.querySelectorAll(".checklist-group").forEach((group, i) => {
      const radios = group.querySelectorAll(`input[name="q${index}_${i}"]`);
      let picked = "";
      radios.forEach(r => { if (r.checked) picked = r.value; });
      answers.push(picked);
      if (picked === "Yes") yesCount++;
      else if (picked === "No") nonCompliant.push(group.querySelector("label").innerText);
    });

    const compliance = ((yesCount / QUESTIONS.length) * 100).toFixed(1);
    audits.push({
      date, auditor, ward, bed,
      isolationRoom,                 // <--- ADDED
      compliance,
      nonCompliantItems: nonCompliant.join("; ") || "None",
      answers
    });
  }

  const safeWard = ward.replace(/[^\w\- ]+/g,"").replace(/\s+/g,"_");
  const safeDate = date.replace(/\//g,"-");
  const filename = `SuctionAudit_${safeWard}_${safeDate}.csv`;

  const result = downloadCSV(auditsToCSV(audits), filename);

  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua);

  if (result.mode === "download") {
    alert("Audit complete. CSV file downloaded.");
  } else if (result.mode === "share-file" || result.mode === "share-text") {
    alert("Audit complete. Share sheet opened – choose where to save or send the CSV.");
  } else if (isIOS && result.mode === "open-tab") {
    alert("Audit complete. A new tab opened with the CSV – tap the Share button and choose “Save to Files”.");
  } else {
    alert("Audit complete. CSV opened in a new tab – use your browser’s Save function.");
  }
}
</script>
</body>
</html>
