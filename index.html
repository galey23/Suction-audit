<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Suction Equipment Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f4f7f8; color: #222; }
    h1 { text-align: center; color: #1c3c4c; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    .form-group { margin-bottom: 15px; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
    .checklist-group { margin: 10px 0; padding-left: 10px; }
    .checklist-group input[type="radio"] { margin-right: 10px; transform: scale(1.2); }
    .audit-block { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 6px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    button { background: #1c3c4c; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; }
    button:hover { background: #235067; }
    .submit-wrapper { text-align: center; margin-top: 30px; }
    .hint { font-size: 0.9em; color: #555; margin-top: 4px; }

    /* --- inline isolation selector next to Bed number, matching font --- */
    .iso-inline { font-weight: normal; margin-left: 10px; }
    .audit-block h3 select {
      font-family: inherit;
      font-size: inherit;
      padding: 2px 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: auto;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div style="text-align: center; margin-bottom: 20px;">
    <img src="MDH-Logo.jpg"
         alt="Mater Dei Hospital Logo"
         style="height: 90px; margin-right: 15px;">
    <img src="RRT Logo (no background).png"
         alt="Rapid Response Team Logo"
         style="height: 90px;">
  </div>

  <h1>Suction Equipment Audit</h1>

  <form id="baseForm" onsubmit="return false;">
    <div class="form-group">
      <label for="auditor">Auditor Name:</label>
      <select id="auditor" required>
        <option value="">Select Auditor</option>
        <option>Yorick</option>
        <option>Duncan PDN</option>
        <option>Jessica</option>
        <option>Bernard</option>
        <option>Nicole</option>
        <option>Stephanie</option>
        <option>Mario</option>
        <option>Miriam</option>
        <option>Josette</option>
        <option>Clint</option>
        <option>Clifford PDN</option>
        <option>Mario PDN</option>
        <option>Justin PDN</option>
        <option>Luke PDN</option>
        <option>Kristin PDN</option>
      </select>
    </div>

    <div class="form-group">
      <label for="date">Date:</label>
      <input type="text" id="date" readonly />
    </div>

    <div class="form-group">
      <label for="ward">Ward:</label>
      <select id="ward" required>
        <option value="">Select Ward</option>
        <!-- Critical Care -->
        <option>ED</option>
        <option>CCU</option>
        <option>SHDU</option>
        <option>NIV</option>
        <!-- Medical -->
        <option>MAU1</option>
        <option>MAU2</option>
        <option>MAU3</option>
        <option>MW1</option>
        <option>MW2</option>
        <option>MW3</option>
        <option>MW4</option>
        <option>MW5</option>
        <option>MW7</option>
        <option>MW8</option>
        <option>MW9</option>
        <option>MW10</option>
        <option>HDU</option>
        <option>MW11</option>
        <option>MIU3</option>
        <option>MIU4</option>
        <option>OBS1A</option>
        <option>MOU</option>
        <option>EVA</option>
        <option>Auxiliary Ward</option>
        <!-- Surgical -->
        <option>PLASITICS</option>
        <option>BRUNS</option>
        <option>ORTHO 1</option>
        <option>ORTHO 2</option>
        <option>ORTHO 3</option>
        <option>SAU1</option>
        <option>SAU2</option>
        <option>SW1</option>
        <option>SW2</option>
        <option>SW3</option>
        <option>SW4</option>
        <option>SW5</option>
        <option>URO 1</option>
        <option>URO 2</option>
        <!-- Speciality Units -->
        <option>CMW</option>
        <option>CSW</option>
        <option>DFW</option>
        <option>ENT</option>
        <option>IDU</option>
        <option>STROKE WARD</option>
        <option>NEURO MED</option>
        <option>NEURO SURG</option>
        <option>SSU</option>
        <!-- OBGYN -->
        <option>Gynae</option>
        <option>EPU</option>
        <option>OBS 1</option>
        <option>OBS 2</option>
        <option>OBS 3</option>
        <!-- SAMOC -->
        <option>HEAMATOLOGY</option>
        <option>ONCO 1</option>
        <option>ONCO 2</option>
        <option>Onco Day Ward</option>
        <option>Palliative</option>
        <option>Renal Unit</option>
      </select>
      <div class="hint">Capacity and number of beds to audit will be auto-filled based on the selected ward.</div>
    </div>

    <div class="form-group">
      <label for="bedCount">Total Beds in Ward:</label>
      <input type="number" id="bedCount" min="1" required />
    </div>

    <div class="form-group">
      <label for="bedsToAudit">Beds to Audit (sample size):</label>
      <input type="number" id="bedsToAudit" min="1" readonly />
    </div>

    <button type="button" onclick="generateAudits()">Generate Bed Audits</button>
  </form>

  <div id="auditContainer"></div>

  <div class="submit-wrapper">
    <button type="button" onclick="submitAudits()">Submit Ward Audit</button>
  </div>

<script>
/* ============================
   POWER AUTOMATE (ANYONE + SIG)
   ============================ */
const FLOW_URL = "https://default34cdd9f55db849bcacba01f65cca68.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ca817088bd6043a187a67a935e85c10e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Dc7DZx1A16KJ29fbIyygPEH1abfDOz41gnjCN7LEBCo";
const FLOW_TIMEOUT_MS = 25000;

// UTF-8 safe base64
function toBase64Utf8(str) {
  const bytes = new TextEncoder().encode(str);
  let binary = "";
  for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

async function postToFlow(payload) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), FLOW_TIMEOUT_MS);

  try {
    const res = await fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`Flow returned ${res.status}. ${txt}`);
    }
  } finally {
    clearTimeout(t);
  }
}

const QUESTIONS = [
  "High suction regulator is present & plugged in to point",
  "Suction regulator functioning well: device turns on and audidible suction present",
  "Suction regulator achives a pressure of 100mmHg (13kPa OR 1.934psi OR 136.0cmH₂O)",
  "Suction canister present next to bed side",
  "Canister liner present",
  "Canister liner tubing present",
  "Liner tubing connected to suction regulator",
  "Patient side tubing present",
  "Compatible catheters present"
];

/* ============================
   ED LOCATIONS (NEW)
   - Cubicles 4..29
   - 16, 22, 23 are doubled (A/B)
   - Plus Decontamination Room, TH1, TH2
   - Randomisation rules:
     * Always include Decontamination Room
     * Always include at least one of the doubled cubicles (16B or 22B or 23B)
   ============================ */
const ED_DOUBLED = ["Cubicle 16A","Cubicle 16B","Cubicle 22A","Cubicle 22B","Cubicle 23A","Cubicle 23B"];
const ED_TH = ["TH1","TH2"];
const ED_DECON = "Decontamination Room";

// Build ED cubicle list 4..29, with special doubles
const ED_LOCATIONS = (() => {
  const out = [];
  for (let n = 4; n <= 29; n++) {
    if (n === 16) out.push("Cubicle 16A", "Cubicle 16B");
    else if (n === 22) out.push("Cubicle 22A", "Cubicle 22B");
    else if (n === 23) out.push("Cubicle 23A", "Cubicle 23B");
    else out.push(`Cubicle ${n}`);
  }
  out.push(ED_DECON, ...ED_TH);
  return out;
})();

function randPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

// Sort for sensible “walking order” in ED
function edSort(a, b) {
  const parse = (s) => {
    // Cubicle 16A etc.
    const m = /^Cubicle\s+(\d+)([AB])?$/.exec(s);
    if (m) return { group: 0, num: parseInt(m[1], 10), suf: m[2] || "" };

    if (s === ED_DECON) return { group: 1, num: 0, suf: "" };
    if (s === "TH1") return { group: 2, num: 1, suf: "" };
    if (s === "TH2") return { group: 2, num: 2, suf: "" };

    // fallback
    return { group: 9, num: 0, suf: s };
  };

  const A = parse(a), B = parse(b);
  if (A.group !== B.group) return A.group - B.group;
  if (A.num !== B.num) return A.num - B.num;
  if (A.suf !== B.suf) return (A.suf || "").localeCompare(B.suf || "");
  return String(a).localeCompare(String(b));
}

function generateEDSelection(sampleSize) {
  if (sampleSize < 3) {
    // You asked for 3 compulsory picks; enforce a minimum of 3 to avoid impossible requests
    throw new Error("ED sample size must be at least 3 to include Decontamination + TH + a doubled cubicle.");
  }

  const chosen = new Set();

  // compulsory
  chosen.add(ED_DECON);
  chosen.add(randPick(ED_TH));
  chosen.add(randPick(ED_DOUBLED));

  // fill rest randomly from remaining ED locations
  const pool = ED_LOCATIONS.filter(x => !chosen.has(x));
  while (chosen.size < sampleSize) {
    if (pool.length === 0) break; // safety
    const idx = Math.floor(Math.random() * pool.length);
    chosen.add(pool[idx]);
    pool.splice(idx, 1);
  }

  return Array.from(chosen).sort(edSort);
}

// Ward configuration: capacity & number of beds to audit
const WARD_CONFIG = {
  // Critical Care
  "ED":            { capacity: 35, sample: 14 },  // UPDATED as requested
  "CCU":           { capacity: 15, sample: 6 },
  "SHDU":          { capacity: 8,  sample: 4 },
  "NIV":           { capacity: 6,  sample: 3 },

  // Medical
  "MAU1":          { capacity: 35, sample: 14 },
  "MAU2":          { capacity: 33, sample: 14 },
  "MAU3":          { capacity: 23, sample: 10 },
  "MW1":           { capacity: 25, sample: 10 },
  "MW2":           { capacity: 25, sample: 10 },
  "MW3":           { capacity: 24, sample: 10 },
  "MW4":           { capacity: 25, sample: 10 },
  "MW5":           { capacity: 39, sample: 16 },
  "MW7":           { capacity: 19, sample: 8 },
  "MW8":           { capacity: 15, sample: 6 },
  "MW9":           { capacity: 23, sample: 10 },
  "MW10":          { capacity: 30, sample: 12 },
  "HDU":           { capacity: 10, sample: 4 },
  "MW11":          { capacity: 30, sample: 12 },
  "MIU3":          { capacity: 14, sample: 6 },
  "MIU4":          { capacity: 24, sample: 10 },
  "OBS1A":         { capacity: 10, sample: 4 },
  "MOU":           { capacity: 13, sample: 6 },
  "EVA":           { capacity: 20, sample: 8 },
  "Auxiliary Ward":{ capacity: 10, sample: 4 },

  // Surgical
  "PLASITICS":     { capacity: 7,  sample: 3 },
  "BRUNS":         { capacity: 4,  sample: 2 },
  "ORTHO 1":       { capacity: 24, sample: 10 },
  "ORTHO 2":       { capacity: 24, sample: 10 },
  "ORTHO 3":       { capacity: 21, sample: 9 },
  "SAU1":          { capacity: 20, sample: 8 },
  "SAU2":          { capacity: 32, sample: 13 },
  "SW1":           { capacity: 25, sample: 10 },
  "SW2":           { capacity: 16, sample: 7 },
  "SW3":           { capacity: 24, sample: 10 },
  "SW4":           { capacity: 24, sample: 10 },
  "SW5":           { capacity: 25, sample: 10 },
  "URO 1":         { capacity: 25, sample: 10 },
  "URO 2":         { capacity: 11, sample: 5 },

  // Speciality Units
  "CMW":           { capacity: 32, sample: 13 },
  "CSW":           { capacity: 17, sample: 7 },
  "DFW":           { capacity: 15, sample: 6 },
  "ENT":           { capacity: 18, sample: 8 },
  "IDU":           { capacity: 20, sample: 8 },
  "STROKE WARD":   { capacity: 25, sample: 10 },
  "NEURO MED":     { capacity: 23, sample: 10 },
  "NEURO SURG":    { capacity: 19, sample: 8 },
  "SSU":           { capacity: 29, sample: 12 },

  // OBGYN
  "Gynae":         { capacity: 11, sample: 5 },
  "EPU":           { capacity: 6,  sample: 3 },
  "OBS 1":         { capacity: 24, sample: 10 },
  "OBS 2":         { capacity: 19, sample: 8 },
  "OBS 3":         { capacity: 20, sample: 8 },

  // SAMOC
  "HEAMATOLOGY":   { capacity: 21, sample: 9 },
  "ONCO 1":        { capacity: 16, sample: 7 },
  "ONCO 2":        { capacity: 17, sample: 7 },
  "Onco Day Ward": { capacity: 45, sample: 18 },
  "Palliative":    { capacity: 16, sample: 7 },
  "Renal Unit":    { capacity: 35, sample: 14 }
};

// Auto-fill date (dd/mm/yyyy EN-GB)
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  const formattedDate = today.toLocaleDateString("en-GB");
  document.getElementById("date").value = formattedDate;

  // When ward changes, auto-fill capacity & sample size
  document.getElementById("ward").addEventListener("change", onWardChange);
});

function onWardChange() {
  const ward = document.getElementById("ward").value;
  const config = WARD_CONFIG[ward];
  const bedCountInput = document.getElementById("bedCount");
  const bedsToAuditInput = document.getElementById("bedsToAudit");

  if (config) {
    bedCountInput.value = config.capacity;
    bedsToAuditInput.value = config.sample;
  } else {
    bedCountInput.value = "";
    bedsToAuditInput.value = "";
  }

  // Clear any previously generated audits when ward changes
  document.getElementById("auditContainer").innerHTML = "";
}

// Generate audits according to ward config
function generateAudits() {
  const ward = document.getElementById("ward").value;
  const bedCount = parseInt(document.getElementById("bedCount").value, 10);
  const bedsToAudit = parseInt(document.getElementById("bedsToAudit").value, 10);
  const container = document.getElementById("auditContainer");

  if (!ward) {
    alert("Please select a ward.");
    return;
  }

  if (!bedCount || bedCount < 1) {
    alert("Please ensure the total number of beds is valid.");
    return;
  }

  if (!bedsToAudit || bedsToAudit < 1) {
    alert("Please ensure the number of beds to audit is valid.");
    return;
  }

  // ED uses a fixed location list (cubicles/rooms) rather than 1..bedCount
  if (ward === "ED" && bedsToAudit > ED_LOCATIONS.length) {
    alert(`ED has ${ED_LOCATIONS.length} selectable locations in the app. Reduce sample size.`);
    return;
  }

  if (ward !== "ED" && bedsToAudit > bedCount) {
    alert("The number of beds to audit cannot exceed the ward capacity.");
    return;
  }

  container.innerHTML = "";

  let selections = [];

  if (ward === "ED") {
    try {
      selections = generateEDSelection(bedsToAudit);
    } catch (e) {
      alert(e.message || "Could not generate ED sample.");
      return;
    }
  } else {
    // original numeric randomisation
    const bedNumbers = [];
    while (bedNumbers.length < bedsToAudit) {
      const n = Math.floor(Math.random() * bedCount) + 1;
      if (!bedNumbers.includes(n)) bedNumbers.push(n);
    }
    bedNumbers.sort((a, b) => a - b);
    selections = bedNumbers.map(n => `Bed ${n}`);
  }

  selections.forEach((label, index) => {
    const div = document.createElement("div");
    div.className = "audit-block";

    // Store the identifier safely (avoids regex parsing issues)
    div.dataset.bed = label;

    div.innerHTML = `
      <h3>
        Audit ${index + 1}: ${label}
        <span class="iso-inline">| Single/Isolation room?
          <select name="iso${index}" required>
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </span>
      </h3>
      ${generateChecklistInputs(index)}
    `;
    container.appendChild(div);
  });

  window.scrollTo({ top: container.offsetTop - 10, behavior: "smooth" });
}

function generateChecklistInputs(index) {
  return QUESTIONS.map((q, i) => `
    <div class="checklist-group">
      <label>${q}</label><br>
      <label><input type="radio" name="q${index}_${i}" value="Yes" required> Yes</label>
      <label><input type="radio" name="q${index}_${i}" value="No"> No</label>
    </div>
  `).join("");
}

// ---- CSV helpers ----
function csvEscape(val) {
  if (val == null) return "";
  const s = String(val);
  return /[",\r\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
}

function auditsToCSV(audits) {
  const header = ["Date","Auditor","Ward","Bed","Single/Isolation Room","Compliance (%)","Non-compliant Items"]
                 .concat(QUESTIONS.map((_,i)=>`Q${i+1}`));
  const lines = [header.map(csvEscape).join(",")];
  audits.forEach(a => {
    const row = [a.date, a.auditor, a.ward, a.bed, a.isolationRoom, a.compliance, a.nonCompliantItems]
      .map(csvEscape).concat((a.answers||[]).map(csvEscape));
    lines.push(row.join(","));
  });
  return lines.join("\r\n");
}

// Cross-platform CSV download / share (unchanged)
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

  const a = document.createElement("a");
  const supportsDownloadAttr = "download" in a;
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua);

  // 1. DESKTOP + ANDROID: normal download
  if (!isIOS && supportsDownloadAttr) {
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
    return { mode: "download" };
  }

  // 2. iOS / ANDROID with Web Share API
  if (navigator.share) {
    try {
      const file = new File([csv], filename, { type: "text/csv" });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          files: [file],
          title: "Suction Audit Export",
          text: "CSV export from Suction Equipment Audit"
        });
        return { mode: "share-file" };
      }
    } catch (e) {
      // fall through
    }

    navigator.share({
      title: "Suction Audit Export",
      text: csv
    }).catch(() => {});
    return { mode: "share-text" };
  }

  // 3. LAST RESORT (mainly older iOS): open CSV in a new tab
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 60000);
  return { mode: "open-tab" };
}

/* ============================
   SUBMIT: sends to flow
   ============================ */
async function submitAudits() {
  const auditor = document.getElementById("auditor").value;
  const date = document.getElementById("date").value;
  const ward = document.getElementById("ward").value;
  const blocks = document.querySelectorAll(".audit-block");

  if (!auditor || !ward || blocks.length === 0) {
    alert("Please fill auditor, select ward and generate the audits first.");
    return;
  }

  const audits = [];

  for (let index = 0; index < blocks.length; index++) {
    const block = blocks[index];

    // Works for BOTH normal wards and ED (no regex needed)
    const bed = block.dataset.bed || (block.querySelector("h3")?.innerText || `Audit ${index+1}`);

    const isoSelect = block.querySelector(`select[name="iso${index}"]`);
    const isolationRoom = isoSelect ? isoSelect.value : "";

    if (!isolationRoom) {
      alert(`Please select Single/Isolation room = Yes/No for ${bed}.`);
      block.scrollIntoView({ behavior: "smooth", block: "center" });
      return;
    }

    const answers = [];
    let yesCount = 0;
    const nonCompliant = [];

    block.querySelectorAll(".checklist-group").forEach((group, i) => {
      const radios = group.querySelectorAll(`input[name="q${index}_${i}"]`);
      let picked = "";
      radios.forEach(r => { if (r.checked) picked = r.value; });
      answers.push(picked);
      if (picked === "Yes") yesCount++;
      else if (picked === "No") nonCompliant.push(group.querySelector("label").innerText);
    });

    const compliance = ((yesCount / QUESTIONS.length) * 100).toFixed(1);
    audits.push({
      date, auditor, ward, bed,
      isolationRoom,
      compliance,
      nonCompliantItems: nonCompliant.join("; ") || "None",
      answers
    });
  }

  const safeWard = ward.replace(/[^\w\- ]+/g,"").replace(/\s+/g,"_");
  const safeDate = date.replace(/\//g,"-");
  const filename = `SuctionAudit_${safeWard}_${safeDate}.csv`;

  const csv = auditsToCSV(audits);

  try {
    await postToFlow({
      date,
      auditor,
      ward,
      filename,
      csvBase64: toBase64Utf8(csv)
    });

    alert("Audit complete. Sent to rrt.mdh@gov.mt.");
  } catch (e) {
    console.error(e);

    // Fallback: keep your existing export behaviour if flow fails
    const result = downloadCSV(csv, filename);
    const ua = navigator.userAgent || "";
    const isIOS = /iPad|iPhone|iPod/.test(ua);

    if (result.mode === "download") {
      alert("Could not send email (network/flow/CORS issue). CSV file downloaded instead.");
    } else if (result.mode === "share-file" || result.mode === "share-text") {
      alert("Could not send email. Share sheet opened – choose where to save or send the CSV.");
    } else if (isIOS && result.mode === "open-tab") {
      alert("Could not send email. A new tab opened with the CSV – tap Share → “Save to Files”.");
    } else {
      alert("Could not send email. CSV opened in a new tab – use your browser’s Save function.");
    }
  }
}
</script>
</body>
</html>
